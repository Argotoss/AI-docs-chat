<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Document Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container-fluid py-4">
        <div class="row justify-content-center">
            <div class="col-lg-10 col-xl-8">
                <h1 class="text-center mb-4">
                    <i class="bi bi-chat-dots-fill text-primary"></i>
                    AI Document Chat
                </h1>
                
                <!-- Main Chat Container -->
                <div class="card shadow-sm">
                    <div class="card-body p-4">
                        <!-- Document Selection Row -->
                        <div class="row g-3 align-items-end mb-4">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Upload or Select Document</label>
                                <div class="input-group">
                                    <input class="form-control" type="file" id="pdfFile" accept=".pdf">
                                    <button class="btn btn-primary" id="uploadBtn" disabled>
                                        <i class="bi bi-upload"></i> Upload
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Available Documents</label>
                                <div class="input-group">
                                    <select id="docSelect" class="form-select">
                                        <option value="">Select a document to chat with...</option>
                                    </select>
                                    <button class="btn btn-danger" id="deleteBtn" disabled>
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" id="refreshBtn">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Status Messages -->
                        <div id="statusMessage" class="mb-3"></div>

                        <!-- Chat Interface -->
                        <div class="border rounded p-3 mb-3" style="min-height: 300px; max-height: 500px; overflow-y: auto; background: #fafafa;" id="chatContainer">
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-chat-square-text fs-1 opacity-50"></i>
                                <p class="mt-3">Upload a PDF and start asking questions!</p>
                            </div>
                        </div>

                        <!-- Question Input -->
                        <div class="input-group">
                            <input type="text" id="questionInput" class="form-control form-control-lg" 
                                   placeholder="Ask a question about your document..." disabled>
                            <button id="askBtn" class="btn btn-success btn-lg" disabled>
                                <i class="bi bi-send"></i> Ask
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="text-center mt-3 text-muted">
                    <small>
                        <i class="bi bi-shield-check"></i>
                        All processing happens locally - your documents never leave your machine
                    </small>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Elements
        const pdfFile = document.getElementById('pdfFile');
        const uploadBtn = document.getElementById('uploadBtn');
        const docSelect = document.getElementById('docSelect');
        const deleteBtn = document.getElementById('deleteBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const statusMessage = document.getElementById('statusMessage');
        const chatContainer = document.getElementById('chatContainer');
        const questionInput = document.getElementById('questionInput');
        const askBtn = document.getElementById('askBtn');

        let currentDocId = null;

        // Utility functions
        function showStatus(message, type = 'info') {
            statusMessage.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
        }

        function addChatMessage(content, isUser = false, isError = false) {
            const messageClass = isUser ? 'bg-primary text-white ms-5' : 
                               isError ? 'bg-danger text-white me-5' : 'bg-white border me-5';
            const icon = isUser ? 'bi-person-fill' : isError ? 'bi-exclamation-triangle-fill' : 'bi-robot';
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `d-flex mb-3 ${isUser ? 'justify-content-end' : ''}`;
            messageDiv.innerHTML = `
                <div class="card ${messageClass}" style="max-width: 80%;">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-start">
                            <i class="bi ${icon} me-2 mt-1"></i>
                            <div>${content}</div>
                        </div>
                    </div>
                </div>
            `;
            
            if (chatContainer.children.length === 1 && chatContainer.children[0].querySelector('.text-muted')) {
                chatContainer.innerHTML = '';
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // File selection
        pdfFile.addEventListener('change', () => {
            uploadBtn.disabled = !pdfFile.files[0];
        });

        // Upload functionality
        uploadBtn.addEventListener('click', async () => {
            const file = pdfFile.files[0];
            if (!file) return;

            uploadBtn.disabled = true;
            showStatus('<i class="bi bi-hourglass-split"></i> Uploading and processing document...', 'info');

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/upload', { method: 'POST', body: formData });
                const data = await response.json();

                if (response.ok) {
                    showStatus(`<i class="bi bi-check-circle"></i> Document uploaded successfully!`, 'success');
                    currentDocId = data.doc_id;
                    await loadDocuments();
                    docSelect.value = currentDocId;
                    enableChat();
                    addChatMessage(`Document "${file.name}" uploaded and ready for questions!`);
                } else {
                    showStatus(`<i class="bi bi-x-circle"></i> Upload failed: ${data.detail}`, 'danger');
                }
            } catch (error) {
                showStatus(`<i class="bi bi-x-circle"></i> Upload error: ${error.message}`, 'danger');
            } finally {
                uploadBtn.disabled = false;
                pdfFile.value = '';
            }
        });

        // Document selection
        docSelect.addEventListener('change', () => {
            currentDocId = docSelect.value;
            deleteBtn.disabled = !currentDocId;
            
            if (currentDocId) {
                enableChat();
                const selectedOption = docSelect.options[docSelect.selectedIndex];
                addChatMessage(`Selected "${selectedOption.text}" - ready for your questions!`);
            } else {
                disableChat();
            }
        });

        // Delete functionality
        deleteBtn.addEventListener('click', async () => {
            if (!currentDocId || !confirm('Are you sure you want to delete this document?')) return;

            deleteBtn.disabled = true;
            showStatus('<i class="bi bi-hourglass-split"></i> Deleting document...', 'info');

            try {
                const response = await fetch(`/documents/${currentDocId}`, { method: 'DELETE' });
                
                if (response.ok) {
                    showStatus('<i class="bi bi-check-circle"></i> Document deleted successfully!', 'success');
                    await loadDocuments();
                    currentDocId = null;
                    disableChat();
                    addChatMessage('Document deleted.', false, false);
                } else {
                    const data = await response.json();
                    showStatus(`<i class="bi bi-x-circle"></i> Delete failed: ${data.detail}`, 'danger');
                }
            } catch (error) {
                showStatus(`<i class="bi bi-x-circle"></i> Delete error: ${error.message}`, 'danger');
            } finally {
                deleteBtn.disabled = false;
            }
        });

        // Refresh documents
        refreshBtn.addEventListener('click', loadDocuments);

        // Load documents
        async function loadDocuments() {
            try {
                const response = await fetch('/documents');
                const data = await response.json();
                
                docSelect.innerHTML = '<option value="">Select a document to chat with...</option>';
                
                data.documents.forEach(doc => {
                    const option = document.createElement('option');
                    option.value = doc.doc_id;
                    option.textContent = `${doc.filename} (${doc.chunk_count} chunks)`;
                    docSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading documents:', error);
            }
        }

        // Enable/disable chat
        function enableChat() {
            questionInput.disabled = false;
            askBtn.disabled = false;
            questionInput.focus();
        }

        function disableChat() {
            questionInput.disabled = true;
            askBtn.disabled = true;
            questionInput.value = '';
        }

        // Ask question
        async function askQuestion() {
            const question = questionInput.value.trim();
            if (!currentDocId || !question) return;

            // Add user message
            addChatMessage(question, true);
            questionInput.value = '';
            askBtn.disabled = true;

            // Add thinking message
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'd-flex mb-3';
            thinkingDiv.innerHTML = `
                <div class="card bg-light border">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2"></div>
                            <em>Thinking...</em>
                        </div>
                    </div>
                </div>
            `;
            chatContainer.appendChild(thinkingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ doc_id: currentDocId, question })
                });

                // Remove thinking message
                chatContainer.removeChild(thinkingDiv);

                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    throw new Error(`Invalid response: ${text.substring(0, 100)}`);
                }

                if (response.ok) {
                    let answer = data.answer;
                    if (data.citations && data.citations.length > 0) {
                        const pages = [...new Set(data.citations.map(c => c.page))];
                        answer += `<br><small class="text-muted"><i class="bi bi-bookmark"></i> Sources: Page ${pages.join(', ')}</small>`;
                    }
                    addChatMessage(answer);
                } else {
                    addChatMessage(data.detail || data.message || 'Unknown error occurred', false, true);
                }
            } catch (error) {
                chatContainer.removeChild(thinkingDiv);
                addChatMessage(`Error: ${error.message}`, false, true);
            } finally {
                askBtn.disabled = false;
            }
        }

        // Ask button click
        askBtn.addEventListener('click', askQuestion);

        // Enter key to ask
        questionInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !askBtn.disabled) {
                askQuestion();
            }
        });

        // Initialize
        loadDocuments();
    </script>
</body>
</html>
