<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Document Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
    <style>
        /* Custom styles for markdown content */
        .chat-message-content h1, .chat-message-content h2, .chat-message-content h3,
        .chat-message-content h4, .chat-message-content h5, .chat-message-content h6 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .chat-message-content h1 { font-size: 1.5rem; }
        .chat-message-content h2 { font-size: 1.3rem; }
        .chat-message-content h3 { font-size: 1.1rem; }
        .chat-message-content h4, .chat-message-content h5, .chat-message-content h6 { font-size: 1rem; }
        
        .chat-message-content p {
            margin-bottom: 0.75rem;
        }
        
        .chat-message-content ul, .chat-message-content ol {
            margin-bottom: 0.75rem;
            padding-left: 1.5rem;
        }
        
        .chat-message-content li {
            margin-bottom: 0.25rem;
        }
        
        .chat-message-content blockquote {
            border-left: 4px solid #dee2e6;
            padding-left: 1rem;
            margin: 1rem 0;
            font-style: italic;
            color: #6c757d;
        }
        
        .chat-message-content code {
            background-color: rgba(0, 0, 0, 0.1);
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .chat-message-content pre {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin: 1rem 0;
            overflow-x: auto;
        }
        
        .chat-message-content pre code {
            background-color: transparent;
            padding: 0;
            border-radius: 0;
        }
        
        .chat-message-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        
        .chat-message-content th, .chat-message-content td {
            border: 1px solid #dee2e6;
            padding: 0.5rem;
            text-align: left;
        }
        
        .chat-message-content th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .chat-message-content hr {
            margin: 1.5rem 0;
            border: 0;
            border-top: 1px solid #dee2e6;
        }
        
        .chat-message-content a {
            color: #0d6efd;
            text-decoration: underline;
        }
        
        .chat-message-content a:hover {
            color: #0b5ed7;
        }
        
        .chat-message-content strong {
            font-weight: 600;
        }
        
        .chat-message-content em {
            font-style: italic;
        }
        
        /* Special styling for citations */
        .chat-message-content hr + p em small {
            color: #6c757d;
            font-size: 0.875rem;
        }
        
        /* Dark theme adjustments for code blocks in light messages */
        .card.bg-white .chat-message-content code {
            background-color: #f8f9fa;
            color: #212529;
        }
        
        .card.bg-white .chat-message-content pre {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
        }
        
        /* Adjustments for text in primary (user) messages */
        .card.bg-primary .chat-message-content * {
            color: white !important;
        }
        
        .card.bg-primary .chat-message-content code {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .card.bg-primary .chat-message-content pre {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .card.bg-primary .chat-message-content blockquote {
            border-left-color: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid py-4">
        <div class="row justify-content-center">
            <div class="col-lg-10 col-xl-8">
                <h1 class="text-center mb-4">
                    <i class="bi bi-chat-dots-fill text-primary"></i>
                    AI Document Chat
                </h1>
                
                <!-- Main Chat Container -->
                <div class="card shadow-sm">
                    <div class="card-body p-4">
                        <!-- Document Selection Row -->
                        <div class="row g-3 align-items-end mb-4">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Upload or Select Document</label>
                                <div class="input-group">
                                    <input class="form-control" type="file" id="pdfFile" accept=".pdf">
                                    <button class="btn btn-primary" id="uploadBtn" disabled>
                                        <i class="bi bi-upload"></i> Upload
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Available Documents</label>
                                <div class="input-group">
                                    <select id="docSelect" class="form-select">
                                        <option value="">Select a document to chat with...</option>
                                    </select>
                                    <button class="btn btn-danger" id="deleteBtn" disabled>
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" id="refreshBtn">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Status Messages -->
                        <div id="statusMessage" class="mb-3"></div>

                        <!-- Chat Interface -->
                        <div class="border rounded p-3 mb-3" style="min-height: 300px; max-height: 500px; overflow-y: auto; background: #fafafa;" id="chatContainer">
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-chat-square-text fs-1 opacity-50"></i>
                                <p class="mt-3">Upload a PDF and start asking questions!</p>
                            </div>
                        </div>

                        <!-- Question Input -->
                        <div class="input-group">
                            <input type="text" id="questionInput" class="form-control form-control-lg" 
                                   placeholder="Ask a question about your document..." disabled>
                            <button id="askBtn" class="btn btn-success btn-lg" disabled>
                                <i class="bi bi-send"></i> Ask
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="text-center mt-3 text-muted">
                    <small>
                        <i class="bi bi-shield-check"></i>
                        All processing happens locally - your documents never leave your machine
                    </small>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/javascript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/java.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/cpp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/sql.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/json.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/xml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/css.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/bash.min.js"></script>
    <script>
        // Elements
        const pdfFile = document.getElementById('pdfFile');
        const uploadBtn = document.getElementById('uploadBtn');
        const docSelect = document.getElementById('docSelect');
        const deleteBtn = document.getElementById('deleteBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const statusMessage = document.getElementById('statusMessage');
        const chatContainer = document.getElementById('chatContainer');
        const questionInput = document.getElementById('questionInput');
        const askBtn = document.getElementById('askBtn');

        let currentDocId = null;

        // Utility functions
        function showStatus(message, type = 'info') {
            statusMessage.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
        }

        // Configure marked with custom renderer
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(code, { language: lang }).value;
                    } catch (err) {}
                }
                return hljs.highlightAuto(code).value;
            },
            langPrefix: 'hljs language-',
            breaks: true,
            gfm: true
        });

        function addChatMessage(content, isUser = false, isError = false) {
            const messageClass = isUser ? 'bg-primary text-white ms-5' : 
                               isError ? 'bg-danger text-white me-5' : 'bg-white border me-5';
            const icon = isUser ? 'bi-person-fill' : isError ? 'bi-exclamation-triangle-fill' : 'bi-robot';
            
            // Process content based on message type
            let processedContent = content;
            if (!isUser && !isError) {
                // Parse markdown for AI responses
                try {
                    processedContent = marked.parse(content);
                } catch (e) {
                    console.warn('Markdown parsing failed:', e);
                    processedContent = content; // Fallback to original content
                }
            } else {
                // For user messages and errors, escape HTML to prevent injection
                processedContent = content.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `d-flex mb-3 ${isUser ? 'justify-content-end' : ''}`;
            messageDiv.innerHTML = `
                <div class="card ${messageClass}" style="max-width: 80%;">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-start">
                            <i class="bi ${icon} me-2 mt-1 flex-shrink-0"></i>
                            <div class="chat-message-content">${processedContent}</div>
                        </div>
                    </div>
                </div>
            `;
            
            if (chatContainer.children.length === 1 && chatContainer.children[0].querySelector('.text-muted')) {
                chatContainer.innerHTML = '';
            }
            
            chatContainer.appendChild(messageDiv);
            
            // Highlight code blocks after adding to DOM
            if (!isUser && !isError) {
                const codeBlocks = messageDiv.querySelectorAll('pre code');
                codeBlocks.forEach(block => {
                    hljs.highlightElement(block);
                });
            }
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // File selection
        pdfFile.addEventListener('change', () => {
            uploadBtn.disabled = !pdfFile.files[0];
        });

        // Upload functionality
        uploadBtn.addEventListener('click', async () => {
            const file = pdfFile.files[0];
            if (!file) return;

            uploadBtn.disabled = true;
            showStatus('<i class="bi bi-hourglass-split"></i> Uploading and processing document...', 'info');

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/upload', { method: 'POST', body: formData });
                const data = await response.json();

                if (response.ok) {
                    showStatus(`<i class="bi bi-check-circle"></i> Document uploaded successfully!`, 'success');
                    currentDocId = data.doc_id;
                    await loadDocuments();
                    docSelect.value = currentDocId;
                    enableChat();
                    addChatMessage(`Document "${file.name}" uploaded and ready for questions!`);
                } else {
                    showStatus(`<i class="bi bi-x-circle"></i> Upload failed: ${data.detail}`, 'danger');
                }
            } catch (error) {
                showStatus(`<i class="bi bi-x-circle"></i> Upload error: ${error.message}`, 'danger');
            } finally {
                uploadBtn.disabled = false;
                pdfFile.value = '';
            }
        });

        // Document selection
        docSelect.addEventListener('change', () => {
            currentDocId = docSelect.value;
            deleteBtn.disabled = !currentDocId;
            
            if (currentDocId) {
                enableChat();
                const selectedOption = docSelect.options[docSelect.selectedIndex];
                addChatMessage(`Selected "${selectedOption.text}" - ready for your questions!`);
            } else {
                disableChat();
            }
        });

        // Delete functionality
        deleteBtn.addEventListener('click', async () => {
            if (!currentDocId || !confirm('Are you sure you want to delete this document?')) return;

            deleteBtn.disabled = true;
            showStatus('<i class="bi bi-hourglass-split"></i> Deleting document...', 'info');

            try {
                const response = await fetch(`/documents/${currentDocId}`, { method: 'DELETE' });
                
                if (response.ok) {
                    showStatus('<i class="bi bi-check-circle"></i> Document deleted successfully!', 'success');
                    await loadDocuments();
                    currentDocId = null;
                    disableChat();
                    addChatMessage('Document deleted.', false, false);
                } else {
                    const data = await response.json();
                    showStatus(`<i class="bi bi-x-circle"></i> Delete failed: ${data.detail}`, 'danger');
                }
            } catch (error) {
                showStatus(`<i class="bi bi-x-circle"></i> Delete error: ${error.message}`, 'danger');
            } finally {
                deleteBtn.disabled = false;
            }
        });

        // Refresh documents
        refreshBtn.addEventListener('click', loadDocuments);

        // Load documents
        async function loadDocuments() {
            try {
                const response = await fetch('/documents');
                const data = await response.json();
                
                docSelect.innerHTML = '<option value="">Select a document to chat with...</option>';
                
                data.documents.forEach(doc => {
                    const option = document.createElement('option');
                    option.value = doc.doc_id;
                    option.textContent = `${doc.filename} (${doc.chunk_count} chunks)`;
                    docSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading documents:', error);
            }
        }

        // Enable/disable chat
        function enableChat() {
            questionInput.disabled = false;
            askBtn.disabled = false;
            questionInput.focus();
        }

        function disableChat() {
            questionInput.disabled = true;
            askBtn.disabled = true;
            questionInput.value = '';
        }

        // Ask question
        async function askQuestion() {
            const question = questionInput.value.trim();
            if (!currentDocId || !question) return;

            // Add user message
            addChatMessage(question, true);
            questionInput.value = '';
            askBtn.disabled = true;

            // Add thinking message
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'd-flex mb-3';
            thinkingDiv.innerHTML = `
                <div class="card bg-light border">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2"></div>
                            <em>Thinking...</em>
                        </div>
                    </div>
                </div>
            `;
            chatContainer.appendChild(thinkingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ doc_id: currentDocId, question })
                });

                // Remove thinking message
                chatContainer.removeChild(thinkingDiv);

                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    throw new Error(`Invalid response: ${text.substring(0, 100)}`);
                }

                if (response.ok) {
                    let answer = data.answer;
                    if (data.citations && data.citations.length > 0) {
                        const pages = [...new Set(data.citations.map(c => c.page))];
                        answer += `\n\n---\n\n*<small><i class="bi bi-bookmark"></i> Sources: Page ${pages.join(', ')}</small>*`;
                    }
                    addChatMessage(answer);
                } else {
                    addChatMessage(data.detail || data.message || 'Unknown error occurred', false, true);
                }
            } catch (error) {
                chatContainer.removeChild(thinkingDiv);
                addChatMessage(`Error: ${error.message}`, false, true);
            } finally {
                askBtn.disabled = false;
            }
        }

        // Ask button click
        askBtn.addEventListener('click', askQuestion);

        // Enter key to ask
        questionInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !askBtn.disabled) {
                askQuestion();
            }
        });

        // Initialize
        loadDocuments();
    </script>
</body>
</html>
